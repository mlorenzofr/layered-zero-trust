{{/*
  Pipeline Registry Auth Secret
  Purpose: Provides dockerconfigjson for pipeline to push/pull images
  Used by: Tekton pipeline tasks (build-image, sign-image, verify-image)
  Created when: quay.enabled=true OR externalRegistry.enabled=true
  Vault path: Automatically selects based on which registry is enabled
    - Built-in Quay: quay.vaultPath (auto-generated credentials)
    - BYO Registry: externalRegistry.vaultPath (user-provided credentials)
  Registry domain:
    - Built-in Quay: auto-constructed as quay-registry-quay-quay-enterprise.<hubClusterDomain>
    - BYO Registry: must be explicitly set via registry.domain
*/}}
{{- if or .Values.quay.enabled .Values.externalRegistry.enabled }}
{{- /* Determine registry domain: auto-construct for built-in Quay, require for external */ -}}
{{- $registryDomain := "" -}}
{{- if .Values.registry.domain -}}
  {{- $registryDomain = .Values.registry.domain -}}
{{- else if .Values.quay.enabled -}}
  {{- $registryDomain = printf "quay-registry-quay-quay-enterprise.%s" .Values.global.hubClusterDomain -}}
{{- else -}}
  {{- fail "registry.domain is required for external registry" -}}
{{- end -}}
---
apiVersion: "external-secrets.io/v1beta1"
kind: ExternalSecret
metadata:
  name: qtodo-registry-auth
  namespace: {{ .Release.Namespace | default .Values.global.namespace }}
spec:
  refreshInterval: 15s
  secretStoreRef:
    name: {{ .Values.global.secretStore.name }}
    kind: {{ .Values.global.secretStore.kind }}
  target:
    name: qtodo-registry-auth
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: |
          {
            "auths": {
              "{{ $registryDomain }}": {
                "auth": "{{ `{{ printf "%s:%s" "` }}{{ .Values.registry.user }}{{ `" .password | b64enc }}` }}"
              }
            }
          }
  data:
  - secretKey: password
    remoteRef:
      {{- if .Values.quay.enabled }}
      key: {{ .Values.quay.vaultPath }}
      property: {{ .Values.quay.passwordVaultKey }}
      {{- else if .Values.externalRegistry.enabled }}
      key: {{ .Values.externalRegistry.vaultPath }}
      property: {{ .Values.externalRegistry.passwordVaultKey }}
      {{- end }}
{{- end }}